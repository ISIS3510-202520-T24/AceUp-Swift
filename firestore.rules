// Firebase Security Rules for Firestore
// Place these rules in your Firebase Console > Firestore Database > Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only access their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Groups - users can only access groups they belong to
    match /groups/{groupId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.members;
      
      // Allow creating new groups
      allow create: if request.auth != null &&
        request.auth.uid in request.resource.data.members;
    }
    
    // Group events - users can only access events from groups they belong to
    match /groups/{groupId}/events/{eventId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
    }
    
    // Assignments - users can only access their own assignments
    match /assignments/{assignmentId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Allow creating new assignments
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
    }
    
    // Shared calendars - similar to groups
    match /sharedCalendars/{calendarId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.members;
      
      allow create: if request.auth != null &&
        request.auth.uid in request.resource.data.members;
    }
    
    // Holidays - read-only for authenticated users
    match /holidays/{holidayId} {
      allow read: if request.auth != null;
      allow write: if false; // Only allow through admin SDK
    }
    
    // Teachers - users can only access their own teacher records
    match /teachers/{teacherId} {
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Allow creating new teachers
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
      
      // Allow updating own teachers
      allow update: if request.auth != null &&
        request.auth.uid == resource.data.userId;
      
      // Allow deleting own teachers
      allow delete: if request.auth != null &&
        request.auth.uid == resource.data.userId;
    }
    
    // Analytics - update sessions (BQ 5.1)
    match /analytics_update_sessions/{sessionId} {
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow update, delete: if false; // Sessions are immutable
    }
    
    // Analytics - notifications log
    match /analytics_notifications/{notificationId} {
      allow read: if request.auth != null;
      allow write: if false; // Only allow through Cloud Functions
    }
    
    // Analytics - insights
    match /analytics_insights/{insightId} {
      allow read: if request.auth != null;
      allow write: if false; // Only allow through Cloud Functions
    }
    
    // Default deny all other documents
    match /{document=**} {
      allow read, write: if false;
    }
  }
}